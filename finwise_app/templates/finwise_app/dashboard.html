{% extends 'finwise_app/base.html' %}
{% load custom_filters %}
{% block content %}
<div class="d-flex align-items-center justify-content-between mb-4">
	<h1 class="h3">Dashboard</h1>
	<div>
		<a class="btn btn-outline-primary me-2" href="{% url 'budgets' %}">Budgets</a>
		<a class="btn btn-primary" href="{% url 'import_transactions' %}">Import OFX</a>
	</div>
</div>
<p class="text-muted">Welcome to your dashboard.</p>

{% if budget_summary %}
<!-- Budget Summary Row -->
<div class="row mb-4">
	<div class="col-12">
		<div class="card">
			<div class="card-header d-flex justify-content-between align-items-center">
				<span>Budget Summary - {{ budget_summary.month|default:"Current Month" }}</span>
				<a href="{% url 'budgets' %}" class="btn btn-sm btn-outline-primary">Manage Budgets</a>
			</div>
			<div class="card-body">
				<div class="row">
					<div class="col-md-3">
						<div class="text-center p-2">
							<i class="bi bi-wallet2 text-primary mb-2" style="font-size: 1.5rem;"></i>
							<h5 class="text-primary mb-1">${{ budget_summary.total_budgeted|floatformat:2 }}</h5>
							<small class="text-muted">Total Budgeted</small>
						</div>
					</div>
					<div class="col-md-3">
						<div class="text-center p-2">
							<i class="bi bi-credit-card text-warning mb-2" style="font-size: 1.5rem;"></i>
							<h5 class="text-warning mb-1">${{ budget_summary.total_spent|floatformat:2 }}</h5>
							<small class="text-muted">Total Spent</small>
						</div>
					</div>
					<div class="col-md-3">
						<div class="text-center p-2">
							<i class="bi bi-piggy-bank text-success mb-2" style="font-size: 1.5rem;"></i>
							<h5 class="text-success mb-1">${{ budget_summary.total_budgeted|add:budget_summary.total_spent|mul:-1|floatformat:2 }}</h5>
							<small class="text-muted">Remaining</small>
						</div>
					</div>
					<div class="col-md-3">
						<div class="text-center p-2">
							{% if budget_summary.over_threshold_count > 0 %}
								<i class="bi bi-exclamation-triangle text-danger mb-2" style="font-size: 1.5rem;"></i>
								<h5 class="text-danger mb-1">{{ budget_summary.over_threshold_count }}</h5>
								<small class="text-muted">Over 80%</small>
							{% else %}
								<i class="bi bi-check-circle text-success mb-2" style="font-size: 1.5rem;"></i>
								<h5 class="text-success mb-1">✓</h5>
								<small class="text-muted">All Good</small>
							{% endif %}
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>
</div>
{% endif %}

<div class="row" id="summary">
	<!-- Filter Section -->
	<div class="col-12 mb-4">
		<div class="card border-secondary">
			<div class="card-header">
				<h6 class="mb-0"><i class="bi bi-funnel me-2"></i>Filter Recent Transactions</h6>
			</div>
			<div class="card-body">
				<form method="get" class="row g-3">
					<div class="col-md-4">
						<label for="account" class="form-label">Account</label>
						<select class="form-select" name="account" id="account">
							<option value="" {% if not selected_account_id %}selected{% endif %}>All Accounts</option>
							{% for account in accounts %}
								<option value="{{ account.id }}" {% if selected_account_id == account.id %}selected{% endif %}>
									{{ account.name|default:account.account_id }} ({{ account.get_type_display }})
								</option>
							{% endfor %}
						</select>
					</div>
					<div class="col-md-4">
						<label for="category" class="form-label">Category</label>
						<select class="form-select" name="category" id="category">
							<option value="" {% if not selected_category_id and not selected_uncategorized %}selected{% endif %}>All Categories</option>
							<option value="uncategorized" {% if selected_uncategorized %}selected{% endif %}>Uncategorized</option>
							{% for category in categories %}
								<option value="{{ category.id }}" {% if selected_category_id == category.id %}selected{% endif %}>
									{{ category.name }}
								</option>
							{% endfor %}
						</select>
					</div>
					<div class="col-md-4">
						<label for="days" class="form-label">Time Period</label>
						<select class="form-select" name="days" id="days">
							<option value="7" {% if days_filter == 7 %}selected{% endif %}>Last 7 days</option>
							<option value="30" {% if days_filter == 30 %}selected{% endif %}>Last 30 days</option>
							<option value="90" {% if days_filter == 90 %}selected{% endif %}>Last 90 days</option>
							<option value="365" {% if days_filter == 365 %}selected{% endif %}>Last year</option>
							<option value="0" {% if days_filter == 0 %}selected{% endif %}>All time</option>
						</select>
					</div>
					<div class="col-md-12">
						<button type="submit" class="btn btn-primary">
							<i class="bi bi-funnel me-1"></i>Apply Filters
						</button>
						<a href="{% url 'dashboard' %}" class="btn btn-outline-secondary">
							<i class="bi bi-arrow-clockwise me-1"></i>Clear Filters
						</a>
					</div>
				</form>
			</div>
		</div>
	</div>

	<div class="col-md-6">
		<div class="card mb-3 accounts-table">
			<div class="card-header d-flex justify-content-between align-items-center">
				<span><i class="bi bi-bank me-2"></i>Accounts</span>
				<span class="badge bg-primary">{{ accounts|length }}</span>
			</div>
			<div class="card-body p-0">
				{% if accounts %}
				<div class="table-responsive">
					<table class="table table-enhanced mb-0">
						<thead>
							<tr>
								<th><i class="bi bi-person-badge me-1"></i>Name</th>
								<th><i class="bi bi-credit-card me-1"></i>Type</th>
								<th><i class="bi bi-building me-1"></i>Bank ID</th>
								<th><i class="bi bi-hash me-1"></i>Account ID</th>
							</tr>
						</thead>
						<tbody>
							{% for a in accounts %}
							<tr>
								<td><strong>{{ a.name|default:'—' }}</strong></td>
								<td><span class="badge bg-secondary">{{ a.get_type_display }}</span></td>
								<td>{{ a.bank_id|default:'—' }}</td>
								<td><code class="text-primary">{{ a.account_id }}</code></td>
							</tr>
							{% endfor %}
						</tbody>
					</table>
				</div>
				{% else %}
					<div class="text-center py-4">
						<i class="bi bi-bank" style="font-size: 2rem; color: #6c757d;"></i>
						<p class="mt-2 text-muted">No accounts yet. Try importing an OFX file.</p>
					</div>
				{% endif %}
			</div>
		</div>
	</div>
	<div class="col-md-6">
		<div class="card mb-3 transactions-table">
			<div class="card-header d-flex justify-content-between align-items-center">
				<span>
					<i class="bi bi-clock-history me-2"></i>Recent Transactions
					{% if filters_active %}
						<span class="badge bg-info">Filtered</span>
					{% endif %}
				</span>
				<a href="{% url 'categories' %}" class="btn btn-sm btn-outline-secondary">
					<i class="bi bi-tags me-1"></i>Categories
				</a>
			</div>
			<div class="card-body p-0">
				{% if recent %}
				<div class="table-responsive">
					<table class="table table-enhanced mb-0">
						<thead>
							<tr>
								<th><i class="bi bi-calendar3 me-1"></i>Date</th>
								<th><i class="bi bi-bank me-1"></i>Account</th>
								<th><i class="bi bi-tag me-1"></i>Category</th>
								<th class="text-end"><i class="bi bi-currency-dollar me-1"></i>Amount</th>
								<th><i class="bi bi-file-text me-1"></i>Description</th>
							</tr>
						</thead>
						<tbody>
							{% for t in recent %}
							<tr>
								<td><strong>{{ t.posted_date|date:'M j' }}</strong></td>
								<td class="text-truncate" style="max-width: 120px;">
									{{ t.account.name|default:t.account.account_id|truncatechars:15 }}
								</td>
								<td>
									{% if t.category %}
										<span class="badge" style="background-color: {{ t.category.color }}; color: white; font-size: 0.75rem;">
											{{ t.category.name|truncatechars:10 }}
										</span>
									{% else %}
										<span class="badge bg-light text-dark" style="font-size: 0.75rem;">Uncategorized</span>
									{% endif %}
								</td>
								<td class="text-end">
									<strong class="{% if t.amount < 0 %}text-danger{% else %}text-success{% endif %}">
										{% if t.amount < 0 %}-{% endif %}${{ t.amount|floatformat:2|cut:'-' }}
									</strong>
								</td>
								<td class="text-truncate" style="max-width: 150px;" title="{{ t.name|default:t.memo }}">
									{{ t.name|default:t.memo|truncatechars:20 }}
								</td>
							</tr>
							{% endfor %}
						</tbody>
					</table>
				</div>
				{% else %}
					<div class="text-center py-4">
						<i class="bi bi-clock-history" style="font-size: 2rem; color: #6c757d;"></i>
						<p class="mt-2 text-muted">No transactions yet.</p>
					</div>
				{% endif %}
			</div>
		</div>
	</div>
</div>
{% endblock %}